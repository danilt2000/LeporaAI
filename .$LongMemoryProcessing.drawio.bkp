<mxfile host="Electron" modified="2025-07-24T03:20:52.840Z" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/23.0.2 Chrome/120.0.6099.109 Electron/28.1.0 Safari/537.36" etag="4NZc_j_rZ1v7UHJGGE0x" version="23.0.2" type="device">
  <diagram id="C5RBs43oDa-KdzZeNtuy" name="Page-1">
    <mxGraphModel dx="3680" dy="1171" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-0" />
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-1" parent="WIyWlLk6GJQsqaUBKTNV-0" />
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-2" value="" style="rounded=0;html=1;jettySize=auto;orthogonalLoop=1;fontSize=11;endArrow=block;endFill=0;endSize=8;strokeWidth=1;shadow=0;labelBackgroundColor=none;edgeStyle=orthogonalEdgeStyle;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WIyWlLk6GJQsqaUBKTNV-3" target="WIyWlLk6GJQsqaUBKTNV-6" edge="1">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-3" value="Lamp doesn&#39;t work" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="547" y="60" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-4" value="Yes" style="rounded=0;html=1;jettySize=auto;orthogonalLoop=1;fontSize=11;endArrow=block;endFill=0;endSize=8;strokeWidth=1;shadow=0;labelBackgroundColor=none;edgeStyle=orthogonalEdgeStyle;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WIyWlLk6GJQsqaUBKTNV-6" target="WIyWlLk6GJQsqaUBKTNV-10" edge="1">
          <mxGeometry y="20" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-5" value="No" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;jettySize=auto;orthogonalLoop=1;fontSize=11;endArrow=block;endFill=0;endSize=8;strokeWidth=1;shadow=0;labelBackgroundColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WIyWlLk6GJQsqaUBKTNV-6" target="WIyWlLk6GJQsqaUBKTNV-7" edge="1">
          <mxGeometry y="10" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-6" value="Lamp&lt;br&gt;plugged in?" style="rhombus;whiteSpace=wrap;html=1;shadow=0;fontFamily=Helvetica;fontSize=12;align=center;strokeWidth=1;spacing=6;spacingTop=-4;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="557" y="150" width="100" height="80" as="geometry" />
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-7" value="Plug in lamp" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="707" y="170" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-8" value="No" style="rounded=0;html=1;jettySize=auto;orthogonalLoop=1;fontSize=11;endArrow=block;endFill=0;endSize=8;strokeWidth=1;shadow=0;labelBackgroundColor=none;edgeStyle=orthogonalEdgeStyle;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WIyWlLk6GJQsqaUBKTNV-10" target="WIyWlLk6GJQsqaUBKTNV-11" edge="1">
          <mxGeometry x="0.3333" y="20" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-9" value="Yes" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;jettySize=auto;orthogonalLoop=1;fontSize=11;endArrow=block;endFill=0;endSize=8;strokeWidth=1;shadow=0;labelBackgroundColor=none;" parent="WIyWlLk6GJQsqaUBKTNV-1" source="WIyWlLk6GJQsqaUBKTNV-10" target="WIyWlLk6GJQsqaUBKTNV-12" edge="1">
          <mxGeometry y="10" relative="1" as="geometry">
            <mxPoint as="offset" />
          </mxGeometry>
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-10" value="Bulb&lt;br&gt;burned out?" style="rhombus;whiteSpace=wrap;html=1;shadow=0;fontFamily=Helvetica;fontSize=12;align=center;strokeWidth=1;spacing=6;spacingTop=-4;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="557" y="270" width="100" height="80" as="geometry" />
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-11" value="Repair Lamp" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="547" y="410" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="WIyWlLk6GJQsqaUBKTNV-12" value="Replace Bulb" style="rounded=1;whiteSpace=wrap;html=1;fontSize=12;glass=0;strokeWidth=1;shadow=0;" parent="WIyWlLk6GJQsqaUBKTNV-1" vertex="1">
          <mxGeometry x="707" y="290" width="120" height="40" as="geometry" />
        </mxCell>
        <mxCell id="FsPQ3sryIhJziz5NWNiH-13" value="" style="ellipse;html=1;shape=endState;fillColor=#000000;strokeColor=#ff0000;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="60" y="440" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="FsPQ3sryIhJziz5NWNiH-14" value="" style="ellipse;html=1;shape=startState;fillColor=#000000;strokeColor=#ff0000;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="60" y="70" width="30" height="30" as="geometry" />
        </mxCell>
        <mxCell id="FsPQ3sryIhJziz5NWNiH-15" value="" style="edgeStyle=orthogonalEdgeStyle;html=1;verticalAlign=bottom;endArrow=open;endSize=8;strokeColor=#ff0000;rounded=0;" edge="1" source="FsPQ3sryIhJziz5NWNiH-14" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="75" y="160" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="FsPQ3sryIhJziz5NWNiH-17" value="&lt;h1&gt;LLM&lt;/h1&gt;&lt;p&gt;system prompt:&lt;/p&gt;&lt;p&gt;главную инфу&amp;nbsp;&lt;/p&gt;&lt;p&gt;фио&amp;nbsp;&lt;/p&gt;&lt;p&gt;инструкции которые надо соблюдать&lt;/p&gt;&lt;p&gt;user prompt:&lt;/p&gt;&lt;p&gt;42&lt;/p&gt;&lt;p&gt;dgfgdfgsdgfds&lt;/p&gt;&lt;p&gt;gsfdgsdfgsfdgsdfgsfdfgsdfgsfd&lt;/p&gt;&lt;p&gt;sdfgsdfgsfdgsdgsfd&lt;/p&gt;&lt;p&gt;sfdggggggggg&lt;/p&gt;&lt;p&gt;sgfddddddddddddddddd&lt;/p&gt;&lt;p&gt;sfgddddddddddddddddddddddddd&lt;/p&gt;&lt;p&gt;fsgdsfgdddddddd&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;" style="text;html=1;strokeColor=none;fillColor=none;spacing=5;spacingTop=-20;whiteSpace=wrap;overflow=hidden;rounded=0;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="223" y="30" width="237" height="460" as="geometry" />
        </mxCell>
        <mxCell id="FsPQ3sryIhJziz5NWNiH-18" value="void GetUserInfo (string userName)&lt;br&gt;&lt;br&gt;{&lt;br&gt;//TODO LOAD USER INFO&lt;br&gt;}" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="-260" y="90" width="260" height="30" as="geometry" />
        </mxCell>
        <mxCell id="FsPQ3sryIhJziz5NWNiH-19" value="вызывать почти каждый раз для последних 4-5 юзеров и кидать в промпт" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="-210" y="190" width="60" height="30" as="geometry" />
        </mxCell>
        <mxCell id="FsPQ3sryIhJziz5NWNiH-20" value="&lt;p&gt;Хороший вопрос. &lt;strong&gt;Куда вставлять память о пользователях — в системный промпт или в обычный контекст?&lt;/strong&gt; Ответ зависит от того, как ты хочешь контролировать модель и насколько часто эта память будет меняться.&lt;/p&gt;&#xa;&lt;hr&gt;&#xa;&lt;h2&gt;&lt;strong&gt;Когда память лучше в &lt;code&gt;System&lt;/code&gt;-промпте&lt;/strong&gt;&lt;/h2&gt;&#xa;&lt;ul&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;Если это &lt;strong&gt;постоянная информация о пользователях&lt;/strong&gt;, которая редко меняется (имя, дата рождения, интересы).&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;Если ты хочешь, чтобы эта информация имела &lt;strong&gt;максимальный приоритет&lt;/strong&gt; — системный промпт почти всегда «переигрывает» инструкции из пользовательских сообщений.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;Если важно, чтобы модель &lt;strong&gt;никогда не игнорировала эти факты&lt;/strong&gt; (например, чтобы всегда называть пользователя по имени).&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;/ul&gt;&#xa;&lt;p&gt;&lt;strong&gt;Пример:&lt;/strong&gt;&lt;/p&gt;&#xa;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;SYSTEM:&#xa;Ты — Aiko, виртуальная айдол-стример. &#xa;&amp;lt;memories&amp;gt;&#xa;Имя пользователя: Danila&#xa;Любимые жанры: JRPG, synthwave&#xa;Текущая цель: найти динамический микрофон&#xa;&amp;lt;/memories&amp;gt;&#xa;&lt;/code&gt;&lt;/pre&gt;&#xa;&lt;hr&gt;&#xa;&lt;h2&gt;&lt;strong&gt;Когда лучше вставлять в обычный контекст&lt;/strong&gt;&lt;/h2&gt;&#xa;&lt;ul&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;Если память &lt;strong&gt;часто обновляется&lt;/strong&gt; (например, последние события на стриме).&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;Если ты используешь &lt;strong&gt;динамическое RAG&lt;/strong&gt; (извлечение релевантных фактов) — тогда каждое сообщение получает небольшой блок памяти вместе с историей чата.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;Когда нужно &lt;strong&gt;сократить количество токенов&lt;/strong&gt; — системный промпт не нужно переписывать при каждом апдейте, можно просто добавлять в &lt;code&gt;context&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;/ul&gt;&#xa;&lt;p&gt;&lt;strong&gt;Пример:&lt;/strong&gt;&lt;/p&gt;&#xa;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;USER: Привет!  &#xa;&amp;lt;memories&amp;gt;Danila ищет новый микрофон.&amp;lt;/memories&amp;gt;&#xa;&lt;/code&gt;&lt;/pre&gt;&#xa;&lt;hr&gt;&#xa;&lt;h2&gt;&lt;strong&gt;Смешанный подход (лучший вариант для VTuber)&lt;/strong&gt;&lt;/h2&gt;&#xa;&lt;ol&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Системный промпт = фиксированная личность + статичные факты.&lt;/strong&gt;&lt;br&gt;&#xa;Пример: имя пользователя, постоянные интересы, привычки.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Динамическая память = подмешивается к каждому запросу в контекст.&lt;/strong&gt;&lt;br&gt;&#xa;Пример: &quot;Последний раз мы шутили про меха-слизней&quot; или &quot;Он выбрал микрофон Samson Q2U&quot;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Периодическое сжатие памяти&lt;/strong&gt; — сессии/истории сводятся в краткие summary и подмешиваются в &lt;code&gt;context&lt;/code&gt; перед ответом.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;/ol&gt;&#xa;&lt;hr&gt;&#xa;&lt;h2&gt;&lt;strong&gt;Примеры промптов при смешанном подходе&lt;/strong&gt;&lt;/h2&gt;&#xa;&lt;p&gt;&lt;strong&gt;System (постоянное):&lt;/strong&gt;&lt;/p&gt;&#xa;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;Ты — Aiko, VTuber-айдол. &#xa;Запомни: Danila — постоянный зритель, любит JRPG и синтвейв. &#xa;Будь позитивной и не выходи из роли.&#xa;&lt;/code&gt;&lt;/pre&gt;&#xa;&lt;p&gt;&lt;strong&gt;Context (динамика):&lt;/strong&gt;&lt;/p&gt;&#xa;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;&amp;lt;memories&amp;gt;&#xa;Сегодня Danila рассказал, что заказал Samson Q2U.&#xa;В прошлый раз мы шутили про меха-слизней.&#xa;&amp;lt;/memories&amp;gt;&#xa;USER: Ты помнишь, что я выбрал?&#xa;&lt;/code&gt;&lt;/pre&gt;&#xa;&lt;hr&gt;&#xa;&lt;h2&gt;&lt;strong&gt;Вывод&lt;/strong&gt;&lt;/h2&gt;&#xa;&lt;ul&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Лучше комбинация:&lt;/strong&gt; статичная память в &lt;code&gt;System&lt;/code&gt;, а динамика — в контекст (&lt;code&gt;USER&lt;/code&gt; или &lt;code&gt;Assistant&lt;/code&gt; сообщение).&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;Если память &lt;strong&gt;очень часто меняется&lt;/strong&gt;, держать всё в &lt;code&gt;System&lt;/code&gt; нецелесообразно (слишком много токенов).&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;Для VTuber логика: &lt;code&gt;System = характер + база зрителей&lt;/code&gt;, &lt;code&gt;Context = последние события и small talk&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;/ul&gt;&#xa;&lt;hr&gt;&#xa;&lt;h3&gt;&lt;strong&gt;Хочешь, я сделаю 3 готовых шаблона промптов (System + Context) для VTuber с памятью?&lt;/strong&gt;&lt;/h3&gt;&#xa;&lt;p&gt;Они будут прямо копируемые в проект — &lt;strong&gt;«Старт стрима», «Апдейт памяти», «Диалог»&lt;/strong&gt;.&lt;/p&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="-900" y="430" width="560" height="2740" as="geometry" />
        </mxCell>
        <mxCell id="FsPQ3sryIhJziz5NWNiH-21" value="&lt;h3&gt;1. Что именно стоит сохранять&lt;/h3&gt;&#xa;&lt;table&gt;&#xa;&lt;thead&gt;&#xa;&lt;tr&gt;&#xa;&lt;th&gt;Тип&lt;/th&gt;&#xa;&lt;th&gt;Примеры&lt;/th&gt;&#xa;&lt;th&gt;Когда удалять / обновлять&lt;/th&gt;&#xa;&lt;/tr&gt;&#xa;&lt;/thead&gt;&#xa;&lt;tbody&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;Статичные факты&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;имя, день рождения, пол, аллергии&lt;/td&gt;&#xa;&lt;td&gt;почти никогда; изменить по явному сигналу&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;Долгосрочные интересы&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;любимые игры/жанры, хобби, любимый цвет&lt;/td&gt;&#xa;&lt;td&gt;если пользователь сам сказал, что вкус изменился&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;Краткосрочные цели&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;“напомни, что я стримлю во вторник”, “ищу новый микрофон”&lt;/td&gt;&#xa;&lt;td&gt;когда цель достигнута или спустя X дней неактивности&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;Контекст последней сессии&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;о чём говорили вчера&lt;/td&gt;&#xa;&lt;td&gt;сворачивайте в краткое summary каждые N сообщений&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;/tbody&gt;&#xa;&lt;/table&gt;&#xa;&lt;p&gt;Такое деление («декларативная ↔ эпизодическая память») позволяет не забивать промпт лишним. (&lt;a href=&quot;https://medium.com/%40nomannayeem/building-ai-agents-that-actually-remember-a-developers-guide-to-memory-management-in-2025-062fd0be80a1?utm_source=chatgpt.com&quot; title=&quot;Building AI Agents That Actually Remember: A Developer&#39;s Guide to ...&quot;&gt;Medium&lt;/a&gt;, &lt;a href=&quot;https://medium.com/%40sonitanishk2003/the-ultimate-guide-to-llm-memory-from-context-windows-to-advanced-agent-memory-systems-3ec106d2a345?utm_source=chatgpt.com&quot; title=&quot;The Ultimate Guide to LLM Memory: From Context Windows to ...&quot;&gt;Medium&lt;/a&gt;)&lt;/p&gt;&#xa;&lt;hr&gt;&#xa;&lt;h3&gt;2. Схема хранения (PostgreSQL&amp;nbsp;+&amp;nbsp;pgvector пример)&lt;/h3&gt;&#xa;&lt;pre&gt;&lt;code class=&quot;language-sql&quot;&gt;CREATE TABLE persons (&#xa;    id            UUID PRIMARY KEY,&#xa;    handle        TEXT,&#xa;    created_at    TIMESTAMPTZ DEFAULT now()&#xa;);&#xa;&#xa;CREATE TABLE memories (&#xa;    id            BIGSERIAL PRIMARY KEY,&#xa;    person_id     UUID REFERENCES persons(id),&#xa;    category      TEXT,           -- static | interest | goal | session&#xa;    key           TEXT,&#xa;    value         TEXT,&#xa;    ts            TIMESTAMPTZ DEFAULT now(),&#xa;    weight        REAL,           -- важность 0‑1&#xa;    expires_at    TIMESTAMPTZ,&#xa;    embedding     VECTOR(1536)    -- для сем. поиска&#xa;);&#xa;-- pgvector index&#xa;CREATE INDEX ON memories USING ivfflat (embedding vector_l2_ops);&#xa;&lt;/code&gt;&lt;/pre&gt;&#xa;&lt;p&gt;&lt;em&gt;Комментарии только по делу, без «вода здесь, огонь там».&lt;/em&gt;&lt;/p&gt;&#xa;&lt;hr&gt;&#xa;&lt;h3&gt;3. Пайплайн&lt;/h3&gt;&#xa;&lt;ol&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Extract&lt;/strong&gt; ― после каждого сообщения прогоняете его через классификатор «это факт, интерес, цель или нет?».&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Score&lt;/strong&gt; ― задаёте &lt;code&gt;weight = recency × importance&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Store&lt;/strong&gt; ― пишете в&amp;nbsp;&lt;code&gt;memories&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Retrieve&lt;/strong&gt; ― перед генерацией ответа:&lt;/p&gt;&#xa;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;q = embed(latest_user_msg)&#xa;rows = sql(&quot;&quot;&quot;&#xa;    SELECT key, value&#xa;    FROM memories&#xa;    WHERE person_id = :uid&#xa;    ORDER BY (embedding &amp;lt;#&amp;gt; :q) ASC, weight DESC&#xa;    LIMIT 10&#xa;&quot;&quot;&quot;)&#xa;summary = summarizer(rows)&#xa;&lt;/code&gt;&lt;/pre&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Inject&lt;/strong&gt; ― вставляете &lt;code&gt;summary&lt;/code&gt; в промпт (см. ниже).&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;/ol&gt;&#xa;&lt;hr&gt;&#xa;&lt;h3&gt;4. Как вставлять в промпт&lt;/h3&gt;&#xa;&lt;p&gt;Используйте явные токены‑ограничители, чтобы защититься от prompt‑injection. (&lt;a href=&quot;https://genai.owasp.org/llmrisk/llm01-prompt-injection/?utm_source=chatgpt.com&quot; title=&quot;LLM01:2025 Prompt Injection - OWASP Gen AI Security Project&quot;&gt;OWASP Gen AI Security Project&lt;/a&gt;, &lt;a href=&quot;https://murraycole.com/posts/llm-memory-injection-attacks?utm_source=chatgpt.com&quot; title=&quot;LLM Memory Injection Attacks — An Engineer-Friendly Primer ...&quot;&gt;Cole Murray - Personal Website&lt;/a&gt;)&lt;/p&gt;&#xa;&lt;pre&gt;&lt;code class=&quot;language-text&quot;&gt;SYSTEM:&#xa;You are Aiko, an energetic VTuber‑idol AI.&#xa;Current date: 2025‑07‑24.&#xa;&#xa;&amp;lt;memories&amp;gt;&#xa;• User: Danila&#xa;• Birthday: 02 Aug&#xa;• Loves: JRPG, synthwave&#xa;• Goal: Find a new dynamic mic&#xa;• Last session (2025‑07‑21): we joked about Mecha‑slimes&#xa;&amp;lt;/memories&amp;gt;&#xa;&#xa;Always greet Danila by name and remember the mic quest.&#xa;&lt;/code&gt;&lt;/pre&gt;&#xa;&lt;p&gt;&lt;em&gt;Альтернативы&lt;/em&gt;&lt;/p&gt;&#xa;&lt;ul&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;YAML&lt;/strong&gt; (читабельно, легко парсить):&lt;/p&gt;&#xa;&lt;pre&gt;&lt;code class=&quot;language-yaml&quot;&gt;memories:&#xa;  static:&#xa;    name: Danila&#xa;  interests:&#xa;    - JRPG&#xa;    - synthwave&#xa;  goal:&#xa;    text: Find dynamic mic&#xa;    set_at: 2025‑07‑21&#xa;&lt;/code&gt;&lt;/pre&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;JSON&lt;/strong&gt; (если нужно отдавать обратно в сервис).&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;/ul&gt;&#xa;&lt;hr&gt;&#xa;&lt;h3&gt;5. Пример минимального кода на Python&lt;/h3&gt;&#xa;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;def remember(uid, category, key, value, weight=0.5, ttl=None):&#xa;    sql(&#xa;        &quot;INSERT INTO memories(person_id,category,key,value,weight,expires_at,embedding)&quot;&#xa;        &quot; VALUES (:uid,:cat,:k,:v,:w,:exp,:embed)&quot;,&#xa;        uid=uid, cat=category, k=key, v=value, w=weight,&#xa;        exp=ttl, embed=embed(value)&#xa;    )&#xa;&#xa;def recall(uid, query, k=10):&#xa;    qvec = embed(query)&#xa;    return sql(&#xa;        &quot;SELECT key, value FROM memories &quot;&#xa;        &quot;WHERE person_id=:uid ORDER BY (embedding &amp;lt;#&amp;gt; :q) ASC LIMIT :k&quot;,&#xa;        uid=uid, q=qvec, k=k&#xa;    )&#xa;&lt;/code&gt;&lt;/pre&gt;&#xa;&lt;hr&gt;&#xa;&lt;h3&gt;6. Безопасность и качество&lt;/h3&gt;&#xa;&lt;ul&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Sanitize input&lt;/strong&gt; → фильтруйте HTML/markdown, проверяйте на токены &lt;code&gt;&amp;lt;/memories&amp;gt;&lt;/code&gt; внутри значений.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Poison‑check&lt;/strong&gt; → если пользователь может писать в память, сканируйте на «явные инструкции изменить поведение». (&lt;a href=&quot;https://arxiv.org/html/2506.23260v1?utm_source=chatgpt.com&quot; title=&quot;From Prompt Injections to Protocol Exploits: Threats in LLM ... - arXiv&quot;&gt;arXiv&lt;/a&gt;)&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;TTL &amp;amp; GC&lt;/strong&gt; → крон‑джоб раз в день удаляет &lt;code&gt;expires_at &amp;lt; now()&lt;/code&gt; или уменьшает &lt;code&gt;weight&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Privacy&lt;/strong&gt; → шифруйте PII в storage; вспоминайте только то, что реально нужно для UX.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;/ul&gt;&#xa;&lt;hr&gt;&#xa;&lt;h4&gt;Коротко&lt;/h4&gt;&#xa;&lt;ol&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Сохраняйте&lt;/strong&gt; отдельные атомарные факты с весом и возможным &lt;code&gt;expires_at&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Извлекайте&lt;/strong&gt; топ‑N или делайте summary перед каждым ответом.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Вставляйте&lt;/strong&gt; в промпт внутри чётких тегов &lt;code&gt;&amp;lt;memories&amp;gt;…&amp;lt;/memories&amp;gt;&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Защищайтесь&lt;/strong&gt; от инъекций и отравленных записей.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;/ol&gt;&#xa;&lt;p&gt;Так ваша AI‑VTuber будет помнить зрителей как настоящий стример, не расходуя контекст впустую и не открываясь для атак. Удачи!&lt;/p&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="-1570" y="460" width="560" height="4140" as="geometry" />
        </mxCell>
        <mxCell id="FsPQ3sryIhJziz5NWNiH-22" value="&lt;h3&gt;8&amp;nbsp;рабочих способов решать — «сохранять ли это в память?»&lt;/h3&gt;&#xa;&lt;table&gt;&#xa;&lt;thead&gt;&#xa;&lt;tr&gt;&#xa;&lt;th&gt;№&lt;/th&gt;&#xa;&lt;th&gt;Сигнал/метод&lt;/th&gt;&#xa;&lt;th&gt;Что именно ловим&lt;/th&gt;&#xa;&lt;th&gt;Как понять, что стоит запомнить&lt;/th&gt;&#xa;&lt;th&gt;Куда класть&lt;/th&gt;&#xa;&lt;/tr&gt;&#xa;&lt;/thead&gt;&#xa;&lt;tbody&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;1&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;&lt;strong&gt;Явная команда&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;Фразы типа «запомни, что…», «пожалуйста, помни…»&lt;/td&gt;&#xa;&lt;td&gt;Ключевые триггеры + регекс/LLM‑классификатор&lt;/td&gt;&#xa;&lt;td&gt;Немедленно в долговременную память&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;2&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;&lt;strong&gt;Редкие личные факты&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;Имя, день рождения, город, аллергии&lt;/td&gt;&#xa;&lt;td&gt;NER → категория &lt;code&gt;PERSONAL_FACT&lt;/code&gt;, встречается ≤ 1 раз&lt;/td&gt;&#xa;&lt;td&gt;Статичный блок (&lt;code&gt;static&lt;/code&gt;)&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;3&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;&lt;strong&gt;Часто повторяющаяся деталь&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;«Я играю только в souls‑like»&lt;/td&gt;&#xa;&lt;td&gt;TF‑IDF / частотный счётчик&amp;nbsp;→ ≥ 3 упоминаний за месяц&lt;/td&gt;&#xa;&lt;td&gt;Интересы (&lt;code&gt;interests&lt;/code&gt;)&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;4&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;&lt;strong&gt;Сильная эмоция или оценка&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;«Этот клип заставил меня плакать»&lt;/td&gt;&#xa;&lt;td&gt;Sentiment &amp;gt; ±0.7&lt;/td&gt;&#xa;&lt;td&gt;Эпизодическая память с высокой важностью&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;5&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;&lt;strong&gt;Активная цель/план&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;«Хочу купить микрофон до пятницы»&lt;/td&gt;&#xa;&lt;td&gt;Ключ «хочу/планирую/ищу» + временной маркер&lt;/td&gt;&#xa;&lt;td&gt;Категория &lt;code&gt;goal&lt;/code&gt;, TTL = дата‑дедлайн&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;6&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;&lt;strong&gt;Новая сущность с контекстом&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;«Мой кот&amp;nbsp;— Барсик, ему 3 года»&lt;/td&gt;&#xa;&lt;td&gt;NER (Pet) + возраст → высокая новизна&lt;/td&gt;&#xa;&lt;td&gt;Custom&amp;nbsp;slot (pets.Barсik)&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;7&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;&lt;strong&gt;Сводка после N сообщений&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;10‑минутный блок чата&lt;/td&gt;&#xa;&lt;td&gt;LLM‑summarizer в 2‑3 строки&lt;/td&gt;&#xa;&lt;td&gt;&lt;code&gt;session_summary&lt;/code&gt; (вытесняет старые)&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;tr&gt;&#xa;&lt;td&gt;&lt;strong&gt;8&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;&lt;strong&gt;Новизна по вектору&lt;/strong&gt;&lt;/td&gt;&#xa;&lt;td&gt;Любая реплика&lt;/td&gt;&#xa;&lt;td&gt;Embedding‑дистанция &amp;gt; θ от существующих фактов&lt;/td&gt;&#xa;&lt;td&gt;Если yes&amp;nbsp;→ создать новую запись&lt;/td&gt;&#xa;&lt;/tr&gt;&#xa;&lt;/tbody&gt;&#xa;&lt;/table&gt;&#xa;&lt;blockquote&gt;&#xa;&lt;p&gt;&lt;strong&gt;Важно:&lt;/strong&gt; методы 2‑6&amp;nbsp;— «горячий» захват во время диалога; 7‑8&amp;nbsp;— фоновый крон‑процесс.&lt;/p&gt;&#xa;&lt;/blockquote&gt;&#xa;&lt;hr&gt;&#xa;&lt;h3&gt;Как это выглядит в памяти&lt;/h3&gt;&#xa;&lt;pre&gt;&lt;code class=&quot;language-yaml&quot;&gt;memories:&#xa;  static:&#xa;    name: Danila&#xa;    birthday: &quot;08‑02&quot;&#xa;  interests:&#xa;    - JRPG&#xa;    - synthwave      # из метода 3&#xa;  pets:&#xa;    Barsik:&#xa;      species: cat&#xa;      age: 3         # метод 6&#xa;  goal:&#xa;    text: Buy dynamic mic&#xa;    deadline: 2025‑08‑01   # метод 5&#xa;  episodic:&#xa;    2025‑07‑24T12:10:&#xa;      text: &quot;Клип заставил меня плакать&quot;   # метод 4&#xa;      weight: 0.9&#xa;  last_summary:&#xa;    2025‑07‑24T12:20:&#xa;      text: &quot;Обсудили микрофоны, договорились сравнить цены.&quot;&#xa;&lt;/code&gt;&lt;/pre&gt;&#xa;&lt;hr&gt;&#xa;&lt;h3&gt;Принцип приоритета&lt;/h3&gt;&#xa;&lt;ol&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;System‑промпт&lt;/strong&gt; получает только &lt;code&gt;static&lt;/code&gt; + &lt;code&gt;interests&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Dynamic context&lt;/strong&gt; (впрыск перед ответом) → последние &lt;code&gt;goal&lt;/code&gt;, &lt;code&gt;episodic(weight &amp;gt; 0.7)&lt;/code&gt;, &lt;code&gt;last_summary&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;Всё остальное лежит в БД и вытаскивается RAG‑запросом лишь при схожих embedding’ах.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;/ol&gt;&#xa;&lt;hr&gt;&#xa;&lt;h3&gt;Мини‑чек‑лист разработчика&lt;/h3&gt;&#xa;&lt;ul&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Фильтр явных команд&lt;/strong&gt;: &lt;code&gt;/(запомни|remember|keep in mind)/i&lt;/code&gt;&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;NER‑классификатор&lt;/strong&gt; с кастом‑лейблами &lt;code&gt;PET&lt;/code&gt;, &lt;code&gt;ALLERGY&lt;/code&gt;, &lt;code&gt;FAVORITE_GAME&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Счётчик повторов&lt;/strong&gt; per slot → &lt;code&gt;if count ≥ k then commit&lt;/code&gt;.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Sentiment/Emotion&lt;/strong&gt; score → сохранять, если |score| ≥ 0.7.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Vector novelty&lt;/strong&gt;: cosine &amp;gt; 0.35 → новая запись, иначе — апдейт существующей (recency boost).&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;li&gt;&#xa;&lt;p&gt;&lt;strong&gt;Garbage Collector&lt;/strong&gt;: еженочно удалять &lt;code&gt;goal&lt;/code&gt; с&amp;nbsp;TTL &amp;lt; today и &lt;code&gt;episodic&lt;/code&gt; с weight &amp;lt; 0.3.&lt;/p&gt;&#xa;&lt;/li&gt;&#xa;&lt;/ul&gt;&#xa;&lt;p&gt;Используя комбинацию этих восьми способов, ты покрываешь и явные просьбы пользователя, и неявные полезные факты, и автоматическое сжатие рутины — ровно то, что нужно живому VTuber‑памяти.&lt;/p&gt;" style="text;whiteSpace=wrap;html=1;" vertex="1" parent="WIyWlLk6GJQsqaUBKTNV-1">
          <mxGeometry x="23" y="570" width="657" height="2520" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
